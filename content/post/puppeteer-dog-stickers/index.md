---
title: "ä½¿ç”¨ Puppeteer çˆ¬å– Google Images ç‹—ç‹—è¡¨æƒ…åŒ…"
date: 2021-08-28T12:42:00+08:00
lastmod: 2021-08-29T00:00:00+08:00
categories: ["Code"]
tags: ["nodejs", "javascript", "spider", "pupperteer"]
slug: "puppeteer-dog-stickers"
image: "cover.webp"
description: "å°æŸ¯åŸºèƒ½æœ‰ä»€ä¹ˆåå¿ƒæ€å‘¢"
---

## ç¼˜èµ·ï¼šè‡ªåŠ¨ç”Ÿæˆç‹—ç‹—è¡¨æƒ…åŒ…

å‰å‡ å¤©æ‰¾æœ‹å‹ç»™æˆ‘åŠ éœ€æ±‚ï¼Œé’°å§ä¾¿æäº†ä¸ªâ€œè‡ªåŠ¨ç”Ÿæˆç‹—ç‹—è¡¨æƒ…åŒ…â€çš„éœ€æ±‚ã€‚ä¸è¿‡å¦‚æœçœŸçš„æŒ‰ç…§éœ€æ±‚çš„åŸæ„ï¼Œå”¯ä¸€çš„è§£å†³æ–¹æ¡ˆå°±åªæœ‰ç”¨åˆ°äººå·¥æ™ºèƒ½äº†ã€‚ç„¶è€Œæœ¬äººæŠ€æœ¯åŠ›å®åœ¨è¿‡èœï¼Œæ‰ä¸åŒ¹ä½ï¼Œåªèƒ½é€€è€Œæ±‚å…¶æ¬¡ï¼Œæ‰¾ä¸€äº›å…¶ä»–çš„è§£å†³æ–¹æ¡ˆäº†ã€‚

## åºŸæ¡ˆï¼šçˆ¬å–QQå†å²å¤´åƒ

ä¸€å¼€å§‹æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆï¼Œè‡ªç„¶æ˜¯åˆ©ç”¨çˆ¬è™«ï¼Œè¿™ä¹Ÿæ­£æ˜¯æœ¬æ–‡çš„ä¸»è¦å†…å®¹ã€‚åæ¥ç”±äºç»†(xiÃ¡n)è‡´(zhe)å…¥(mÃ©i)å¾®(shÃ¬)çš„è§‚å¯Ÿï¼Œå‘ç°é’°å§çš„ç»å¸¸æ›´æ–°ä¸€äº›ç‹—ç‹—å¤´åƒã€‚äºæ˜¯ä¾¿æœ‰äº†æ–°æ€è·¯ï¼Œèƒ½å¦é€šè¿‡è‡ªåŠ¨å®šæ—¶çˆ¬å–é’°å§çš„QQå¤´åƒï¼Œä»¥è‡ªåŠ¨è·å–ç‹—ç‹—è¡¨æƒ…åŒ…å‘¢ï¼Ÿ

å…³äºè¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä¸€å¼€å§‹æƒ³åˆ°çš„æ˜¯åˆ©ç”¨â€œè·å–QQå¤´åƒâ€çš„æ¥å£è¿›è¡Œè½®è¯¢ï¼Œè®¡ç®—å½“å‰å¤´åƒå“ˆå¸Œå€¼å¹¶ä¸ä¸Šä¸€æ¬¡è·å–åˆ°çš„å¤´åƒçš„å“ˆå¸Œå€¼ä½œæ¯”è¾ƒï¼Œè‹¥ä¸åŒåˆ™ä¿å­˜ä¸‹è½½ã€‚ä½†æ˜¯è½®è¯¢çš„æ—¶é—´é—´éš”å®åœ¨ä¸å¤ªå¥½è®¾å®šã€‚å› ä¸ºå¤´åƒçš„æ›´æ–°æ—¶é—´å¹¶ä¸å›ºå®šï¼Œå¯èƒ½ä¸€å¤©æ›´æ–°æ•°æ¬¡ï¼Œä¹Ÿå¯èƒ½æ•°å¤©æ›´æ–°ä¸€æ¬¡ã€‚å¦‚æœè®¾å®šè½®è¯¢é—´éš”æ—¶é—´è¿‡çŸ­ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ï¼Œä¸¥é‡çš„è¯è¯´ä¸å®šè…¾è®¯ä¼šç›´æ¥æŠŠæˆ‘ç»™
ban äº†ã€‚è€Œå¦‚æœè®¾å®šè½®è¯¢é—´éš”æ—¶é—´è¿‡é•¿ï¼Œä¾¿ä¼šå¯¼è‡´è·å–åˆ°çš„å¤´åƒå¤§æ¦‚ç‡æ˜¯æœ‰é—æ¼çš„ã€‚

è€ƒè™‘åˆ°æ›´æ–°å¤´åƒç»ˆç©¶æ˜¯ç”±äººç±»æ¥å®Œæˆçš„ï¼Œå› æ­¤ä¹Ÿéœ€è¦è€ƒè™‘åˆ°åˆ©ç”¨ä¸€äº›ç¤¾ä¼šå·¥ç¨‹å­¦ä¿¡æ¯ä»¥å¯¹ç¨‹åºè¿›è¡Œä¼˜åŒ–ã€‚æ¯”å¦‚åœ¨æ·±å¤œå‡Œæ™¨çš„æ—¶å€™ï¼Œå¯ä»¥é€‚æ—¶åœæ­¢çˆ¬è™«ä»¥é™ä½è´Ÿè½½ã€‚ä½†æ˜¯è€ƒè™‘åˆ°è¿™ä¸ªä½œæ¯è§„å¾‹...å’³å’³...è¿˜æ˜¯ç®—äº†å§ï¼Œæ¯•ç«Ÿæ˜¨æ™šå‡Œæ™¨è¿˜åˆšåˆšçœ‹åˆ°é’°å§åˆæ¢äº†æ–°å¤´åƒæ¥ç€ã€‚

~~ï¼ˆé‚£æ—¢ç„¶æˆ‘èƒ½å‘ç°åˆ«äººåœ¨ç†¬å¤œå†…å·ï¼Œé‚£å²‚ä¸æ˜¯è¯´æ˜æˆ‘ä¹Ÿæ˜¯åœ¨ç†¬å¤œæ‘¸é±¼?ï¼‰~~

~~ï¼ˆå•Šè¿™ï¼Œå¥½åƒæœ‰é“ç†è¯¶ğŸ˜¥ï¼‰~~

![](0.jpg)

åˆè€ƒè™‘åˆ°äººç±»æ˜¯ä¸€ç§ä¼˜æŸ”å¯¡æ–­çš„ç”Ÿç‰©ï¼Œæ‰€ä»¥æ¯æ¬¡æ¢å®Œå¤´åƒåçš„ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½æœ‰è¾ƒé«˜çš„æ¦‚ç‡å†æ¬¡æ¢ä¸ªå¤´åƒã€‚å› æ­¤åœ¨ä¾¦æµ‹åˆ°å¤´åƒæ›´æ–°åï¼Œå¯ä»¥è°ƒé«˜åœ¨æœªæ¥ä¸€æ®µçŸ­æ—¶é—´å†…çš„è½®è¯¢é¢‘ç‡ã€‚ä½†æ˜¯è¿™ä¹Ÿä¸èƒ½æ’é™¤åœ¨æé«˜è½®è¯¢é¢‘ç‡ä¹‹å‰çš„é—æ¼æƒ…å†µã€‚

å†µä¸”ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆæ‰€æ”¶é›†åˆ°çš„è¡¨æƒ…åŒ…æ•°é‡è¿˜æ˜¯åŠå…¶æœ‰é™çš„ï¼Œå¦‚æœæƒ³è¦æ”¶é›†åˆ°è¶³å¤Ÿæ•°é‡çš„å¤´åƒï¼Œä¼°è®¡æ—©è¿‡ deadline äº†ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜æ˜¯è¢« pass æ‰äº†ã€‚

## é¢„å¤‡ï¼šä» Selenium åˆ° Puppeteer

ä¸Šé¢çš„æ–¹æ¡ˆåºŸå¼ƒåï¼Œè‡ªç„¶ä¾¿æ˜¯åœ¨ç½‘ä¸Šæ‰¾ä¸€äº›é€‚åˆçˆ¬å–çš„ç½‘ç«™è¿›è¡Œçˆ¬è™«äº†ã€‚

- åœ¨çŸ¥ä¹ä¸Šæœç´¢â€œç‹—ç‹—è¡¨æƒ…åŒ…â€å…³é”®å­—ï¼Œå›ç­”æ•°é‡æœ€å¤šçš„é—®é¢˜ä¸‹ä¹Ÿä¸è¿‡åªæœ‰åå‡ ä¸ªå›ç­”ã€‚Passã€‚

- æ‰¾åˆ°ä¸€äº›è¡¨æƒ…åŒ…ç½‘ç«™ï¼Œæœç´¢å…³é”®å­—ï¼Œè´¨é‡è¿‡ä½ã€‚Passã€‚

- ç™¾åº¦å›¾ç‰‡æœç´¢å…³é”®å­—ï¼Œç»“æœè¿˜è¡Œï¼Œç„¶è€Œå¯¹ç™¾åº¦æ²¡ä»€ä¹ˆå¥½æ„Ÿï¼Œæœ‰è°·æ­Œæˆ‘è¿˜ç”¨ä»€ä¹ˆç™¾åº¦ã€‚Passã€‚

äºæ˜¯å°†ç›®æ ‡é”å®šåˆ°äº† Google Images.

é¢„è°ƒè¯•é˜¶æ®µï¼Œåˆ©ç”¨ devtools çš„ network æ å‘ç°è™½ç„¶å›¾ç‰‡æ˜¯åŠ¨æ€åŠ è½½ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä½¿ç”¨ Fetch/XHRï¼Œè€Œæ˜¯åœ¨å‘é€äº†ä¸€äº› Other ç±»çš„ imgevent è¯·æ±‚ï¼Œå…·ä½“åŸç†æˆ‘ä¹Ÿä¸æ¸…æ¥šã€‚å› æ­¤è¿™é‡Œä¹Ÿä¸èƒ½ç”¨æ™®é€šçš„ Request è§£å†³äº†ã€‚ä¹‹å‰è®°å¾—å¬è¯´è¿‡ä¸€ç§å«åš Chrome headless çš„ä¸œè¥¿ï¼Œæœç´¢ä¹‹åå‘ç°äº† Seleniumï¼Œé‚å¼€å§‹å‡†å¤‡å­¦ä¹  Selenium è¿›è¡Œçˆ¬è™«ã€‚ä¸è¿‡æ–‡ç« å†™åˆ°è¿™å„¿çš„æ—¶å€™åˆå‘ç°äº† Google æäº†ä¸ª Puppeteer ä¸œè¥¿ï¼Œè²Œä¼¼å¯¹ NodeJS æ›´åŠ æ˜“ç”¨ä¸€äº›ï¼Œç„¶åä¾¿åˆè½¬æˆ˜ Google Puppeteer äº†ã€‚

Puppeteer çš„å®˜æ–¹ä»‹ç»ï¼š

> Puppeteer is a Node library which provides a high-level API to control Chrome or Chromium over the DevTools Protocol. Puppeteer runs headless by default, but can be configured to run full (non-headless) Chrome or Chromium.

è‡ªå·±ç¨å¾®ç¿»è¯‘ä¸€ä¸‹ï¼š

> Puppeteer æ˜¯ä¸€ä¸ª Node åº“ï¼Œå®ƒåœ¨ DevTools åè®®ä¹‹ä¸Šæä¾›äº†é«˜åº¦å°è£…çš„ APIï¼Œä»¥ç”¨æ¥æ§åˆ¶ Chrome æˆ– Chromium. Puppeteer ä¼šé»˜è®¤è¿è¡Œ headless, ä½†æ˜¯å¯ä»¥é€šè¿‡è¿›è¡Œé…ç½®æ¥è¿è¡Œå®Œæ•´ç‰ˆçš„ (non-headless)  Chrome æˆ– Chromium.

## æ­£æ–‡ï¼šå°±ç¡¬çˆªå·´

é¦–å…ˆçœ‹ä¸€ä¸‹ Puppeteer çš„[å®˜æ–¹æ–‡æ¡£](https://pptr.dev/)ã€‚

æ¥ç€è€ä¸‰æ ·ï¼š

```bash
mkdir dog-stickers
cd dog-stickers
npm init -y
echo node_modules > .gitignore
git init
```

å®‰è£… `puppeteer`ï¼š

```bash
npm install puppeteer
```

å¦‚æœæ²¡æœ‰è‡ªåŠ¨ä¸‹è½½ Chromiumï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨ä¸‹è½½ï¼š

```bash
cd node_modules/puppeteer
npm install
```

æ¥ä¸‹æ¥å†™ä¸ª demo æµ‹è¯•ä¸€ä¸‹ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»ºä¸€ä¸ª `index.js`ï¼Œå†™å…¥ï¼š

```js
const puppeteer = require('puppeteer');

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.goto('https://example.com');
  await page.screenshot({ path: 'example.png' });

  await browser.close();
})();
```

ç„¶å `node index.js`ï¼Œå¦‚æœé¡¹ç›®æ ¹ç›®å½•ä¸‹é¢ç”Ÿæˆä¸€å¼ æˆªå›¾æ–‡ä»¶ï¼Œè¯´æ˜å®‰è£…æˆåŠŸäº†ã€‚

![example.png](example.png)

ç„¶ååªè¦å†ç¨å¾®åŠ å‡ è¡Œä»£ç ï¼ˆè¿«çœŸï¼‰ï¼Œæˆ‘ä»¬çš„ç¨‹åºå°±å®Œæˆäº†ï¼š

```js
import { promises as fs } from 'fs';
import puppeteer from 'puppeteer';

async function isReachedBottom(page) {
     return await page.evaluate(() => {
          const scrollHeight = document.documentElement.scrollHeight;
          const clientHeight = document.documentElement.clientHeight;
          const scrollTop = document.documentElement.scrollTop;
          return scrollHeight === Math.round(clientHeight + scrollTop);
     })
}

async function getLoadingStatus(page) {
     return await page.evaluate(() => {
          return document.querySelector(".DwpMZe").getAttribute('data-status')
     })
}


(async () => {
     const browser = await puppeteer.launch({ headless: true });
     const page = await browser.newPage();
     /* è¿™é‡Œè¦é‡æ–°è®¾ç½®è§†çª—å¤§å°ï¼Œ
     ä¸€æ˜¯å› ä¸ºé»˜è®¤çš„è§†çª—å¤§å°ä¼šå¯¼è‡´æµè§ˆå™¨å‡ºç°æ¨ªå‘æ»šåŠ¨æ¡ï¼Œè°ƒå¤§çª—å£å¯ä»¥æ–¹ä¾¿è°ƒè¯•ï¼Œ
     äºŒæ˜¯å› ä¸ºæˆ‘çŒœæµ‹ Google Images å¯¹äºä¸åœ¨è§†çª—èŒƒå›´å†…çš„å›¾ç‰‡ URL å¯èƒ½ä¸ä¼šè¿›è¡ŒåŠ è½½ï¼Œ
     ä½¿ç”¨é»˜è®¤è§†çª—å¤§å°æ€»ä¼šå‡ºç°å¤§é‡ Empty çš„æƒ…å†µï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘çŒœæµ‹çš„åŸå› ã€‚*/
     await page.setViewport({
          width: 1280,
          height: 720,
     });
     await page.goto('https://www.google.com.hk/search?q=image&tbm=isch');
     // æ»šï¼ˆdoge
     /* è¿™é‡Œ scrollBy å’Œ waitForTimeout çš„å‚æ•°å¤§å°éƒ½æ˜¯ç»è¿‡ N å¤šæ¬¡è°ƒè¯•ç¡®å®šçš„ï¼Œ
     scrollBy å¤ªå¤§ã€waitForTimeout å¤ªå°ä¼šå› ä¸ºæ»‘åŠ¨è¿‡å¿«è€Œå¯¼è‡´å‡ºç°é—æ¼æƒ…å†µï¼Œåä¹‹åˆ™ä¼šå¯¼è‡´è€—æ—¶è¿‡é•¿ã€‚
     è¿™é‡Œçš„å‚æ•°å’Œè¿è¡Œç¯å¢ƒçš„ç½‘é€Ÿã€é…ç½®ç­‰éƒ½æœ‰å…³ç³»ï¼Œæ‰€ä»¥åœ¨å…¶ä»– PC ä¸Šå¹¶ä¸èƒ½ä¿è¯èƒ½å¤Ÿå®Œç¾è¿è¡Œã€‚*/
     while (true) {
          await page.evaluate(() => window.scrollBy(0, 200))
          await page.waitForTimeout(100);
          if (await isReachedBottom(page)) {
               if (await getLoadingStatus(page) !== "1")
                    break;
               else
                    console.log(`Loading new images...`)
          };
     }
     // çˆªå·´.jpg
     const images = await page.evaluate(() => {
          const list = [...document.querySelector('.islrc').children];
          return list.map(div => div.firstChild.firstChild.firstChild.src)
     })
     console.log(`All: ${images.length}\nEmpty: ${images.filter(src => src === "").length}`)
     // æ‹¿æ¥å§ä½ .jpg
     await fs.writeFile('images.json', JSON.stringify(images, null, 4));
     // ä»Šå¤©çš„ç‹—ç‹—å°±çœ‹åˆ°è¿™å„¿äº†.jpg
     await browser.close();
})();
```

è¯´å‡ ä¸ªè¦æ³¨æ„çš„ç‚¹ï¼Œé¦–å…ˆæ˜¯æˆ‘ä½¿ç”¨äº† `import` è¯­å¥ï¼Œæ‰€ä»¥éœ€è¦åœ¨ `package.json` ä¸­åŠ ä¸€è¡Œ `"type": "module"`ã€‚å…¶ä»–éœ€è¦æ³¨æ„çš„ç‚¹éƒ½å†™åœ¨ä»£ç æ³¨é‡Šé‡Œé¢äº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚

ç¨‹åºè¿è¡Œå®Œæˆä¹‹åä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `images.json` æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜å›¾ç‰‡çš„ URL åœ°å€ã€‚å…¶ä¸­æœ‰äº›æ˜¯å›¾ç‰‡é“¾æ¥ï¼Œæœ‰äº›æ˜¯ç›´æ¥ä»¥ base64 çš„å½¢å¼å‚¨å­˜èµ·æ¥ï¼Œè¿˜æœ‰çš„æ˜¯ `null`ã€‚è‡³äºä¸ºä»€ä¹ˆä¼šå‡ºç° `null` æˆ‘ä¹Ÿæ‡’å¾—å»æ·±ç©¶äº†ï¼Œåæ­£æ€»æ•°è¿˜æ˜¯å¾ˆå°‘çš„ã€‚

å¯¹äº†ï¼ŒPuppeteer çš„æ–‡æ¡£æœ‰è¿™æ ·ä¸€æ®µè¯ï¼š

> Puppeteer has event-driven architecture, which removes a lot of potential flakiness. Thereâ€™s no need for evil â€œsleep(1000)â€ calls in puppeteer scripts.

æ„Ÿè§‰æˆ‘ä»£ç é‡Œé¢ä¹Ÿæ²¡å°‘å†™ `sleep()` å‘€ğŸ˜…ï¼Œä¹Ÿè®¸åªæ˜¯å› ä¸ºæˆ‘å¤ªèœäº†å§ã€‚

## ä¸‹è½½

è·å–åˆ° `images.json` åå°±å¥½è¯´äº†ï¼Œéå†é“¾æ¥ä¸‹è½½å³å¯ï¼š

```js
import { promises as fs } from 'fs';
import download from 'download';

async function downloadFromBase64(path, url) {
    const data = url.replace(/^data:image\/\w+;base64,/, "");
    await fs.writeFile(path, data, 'base64');
}

async function downloadFromUrl(path, url) {
    await fs.writeFile(path, await download(url));
}


(async () => {
    const links = JSON.parse(await fs.readFile("images.json", { encoding: "utf-8"}));
    links.forEach(async (link, index) => {
        if (/^http/.test(link)) {
            await downloadFromUrl(`images/${index}.jpeg`, link)
            console.log(`Downloaded images/${index}.jpeg...`)
        } else if (/^data/.test(link)) {
            await downloadFromBase64(`images/${index}.jpeg`, link)
            console.log(`Downloaded images/${index}.jpeg...`)
        }
    })
})()
```

Google Images çš„é¢„è§ˆå›¾å¥½åƒéƒ½æ˜¯ `jpeg` æ ¼å¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±å…¨éƒ¨é»˜è®¤æ‰©å±•åä¸º `jpeg` äº†ã€‚

ä¸‹è½½çš„å›¾ç‰‡ä¼šä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `images` æ–‡ä»¶å¤¹ã€‚

## æ€»ç»“

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œä¸»è¦æ˜¯å­¦ä¹ äº†ä¸€ç‚¹ Puppeteer çš„åŸºç¡€ä½¿ç”¨ï¼ˆçœŸçš„æ˜¯éå¸¸åŸºç¡€äº†ï¼‰ï¼Œå°½ç®¡è‡ªå·±å†™çš„ä»£ç å¹¶ä¸æ€ä¹ˆä¼˜é›…ã€‚ä¸è¿‡æ—¥åä¹Ÿä¸çŸ¥é“ä¹Ÿä¸çŸ¥é“è¿˜èƒ½ä¸èƒ½å†ç”¨åˆ°è¿™ä¸ªåº“ã€‚å¦å¤–å°±æ˜¯æ„Ÿè§‰è‡ªå·±æœ€è¿‘ä¸€ä¸ªæœˆæ­£ç»é¡¹ç›®æ²¡æ€ä¹ˆå†™ï¼Œåå€’æ˜¯å„ç§è„šæœ¬éƒ½å†™äº†ä¸€å †äº†ğŸ˜¹